name: Fetch BF6 Stats via Scraping

on:
  # Umožňuje spustit akci manuálně
  workflow_dispatch: 
  schedule:
    - cron: '0 2 * * *' # Běží každý den v 02:00 UTC

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # Povoluje commit zpět do repozitáře
      
    steps:
      - name: Checkout kód
        uses: actions/checkout@v4
      
      - name: Vytvoření složky pro data
        run: mkdir -p data

      - name: Stáhni HTML obsah stránky (Scraping)
        id: scrape
        run: |
          URL="https://tracker.gg/bf6/profile/steam/3000691765/overview"
          HTML_OUTPUT="data/bf6_page.html"
          
          echo "Stahuji veřejnou HTML stránku pro Steam ID 3000691765..."
          
          # Simulace prohlížeče pomocí User-Agent
          curl -s -L -A "Mozilla/5.0 (GitHubActions)" "$URL" --output "$HTML_OUTPUT"
          
          if [ -f "$HTML_OUTPUT" ]; then
              echo "HTML staženo, pokračuji extrakcí dat."
              
              # Tady musíme najít data (jsou v JS proměnné)
              # Použijeme grep a sed k extrakci velkého JSON bloku z HTML
              JSON_DATA=$(grep -oP 'window.__INITIAL_STATE__\s*=\s*\K[^{]*\{.*\}' "$HTML_OUTPUT" | head -n 1)
              
              if [ -z "$JSON_DATA" ]; then
                  echo "❌ CHYBA: Nepodařilo se najít iniciační data v HTML (Web scraping selhal)."
                  exit 1
              fi
              
              # Uložíme extrahovaná data do finálního JSON souboru
              echo "$JSON_DATA" > "data/bf6_stats.json"
              echo "Data úspěšně extrahována a uložena."
          else
              echo "❌ CHYBA: Stránka nebyla stažena."
              exit 1
          fi

      - name: Commit a Push JSON souboru
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: 'data/bf6_stats.json' 
          commit_message: 'Auto-update: BF6 Stats via Web Scraping'
          commit_author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
